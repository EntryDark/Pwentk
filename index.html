<!doctype html>
<meta charset="utf-8">
<html>
<head>
	<!-- jQuery -->
	<script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
	<!-- Semantic-UI -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css">
	<script src="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.js"></script>
	<!-- Vue -->
	<script src="https://unpkg.com/vue@2.6.2/dist/vue.js"></script>
	<!-- FabricJS -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/2.6.0/fabric.js"></script>
	<!-- interact.js -->
	<script src="https://cdn.jsdelivr.net/npm/interactjs@1.3.4/dist/interact.min.js"></script>
	<!-- Pwentk -->
	<script src="pwentk.js"></script>
	<!-- Fonts -->
	<link href="https://fonts.googleapis.com/css?family=Noto+Sans+KR:400,700,900" rel="stylesheet">

	<style>
	body{
		font-family: "Lato", "Noto Sans KR", sans-serif;
		font-weight: 400;
	}
	#main{
		padding: 20px;
	}
	.canvas-container canvas{
		border-radius: 10px;
	}
	#mainCanvas{
		box-shadow: 0 0 10px black;
	}
	.topbar{
		background-color: #eb58ab !important;
		border-radius:0 !important;
		margin:0px 0 -10px 0 !important;
	}
	#topbar div{
		padding-top: 0 !important;
		padding-bottom: 0 !important;
	}
	#scene a{
		padding-top: 0 !important;
	}
	.block{
		stroke-width:0.3px;
		stroke-linecap:butt;
	}
	.basic{
		fill:#6691e8; 
		stroke:#81a7f4;
	}
	.blockText{ 
		font: 6px "Lato", "Noto Sans KR", sans-serif; 
		fill: auto;
	}
</style>
</head>
<body>
	<div id="app" style="height: 100%;">
		<div id="topbar" class="ui borderless inverted menu topbar">
			<div class="item">
				<img class="ui tiny image" src="logo.svg" style="fill:white;">
			</div>
			<div class="right menu">
				<div class="item">
					Lorem!
				</div>
			</div>
		</div>
		<div class="ui inverted segment topbar" style="padding:0 5px 10px 5px;">
			<div id="scene" class="ui secondary pointing inverted menu" style="border:0;">
				<a class="item" :class="{'active':scene.active}" @click="sceneChange(index);" v-for="(scene, index) in scenes">
					{{scene.name}}
				</a>
				<a class="item" @click="scenes.push({name: '장면 ' + (scenes.length+1), active: false})">
					<i class="plus icon"></i>
				</a>
			</div>
		</div>
		<div id="main" class="ui stackable two column grid" style="height: 100%;">
			<div class="column">
				<div id="canvases">
					<canvas id="mainCanvas" height="360" width="640"></canvas>
				</div>
			</div>
			<div class="column">
				<div class="ui segment" style="height: 100%;">
					<svg class="ws" id="ws" style="width:100%;height:100%;">
						<pwentk-block text="테스트">
						</pwentk-block>
					</svg>
				</div>
			</div>
		</div>
	</div>
	<script>
		function canvasResize(){
			canvas.setWidth($("#canvases").parent().width());
			canvas.setHeight($("#canvases").parent().width()/16*9);
			canvas.setDimensions({width: 1920, height: 1080},{backstoreOnly:true});
		}
		var ws = {
			scale: 3
		};
		var block = Vue.component("pwentk-block",{
			template: `<g :class="['draggable', 'blockGroup', {clicked: clicked}]"
			:style="{transform:'translate('+x+'px,'+y+'px) scale('+ws.scale+')'}">
			<path class="basic block" 
			:d="getPath(text)"/>
			<text class="blockText" x="7.5" y="7">{{text}}</text>
			</g>`,
			props:["text"],
			data(){
				return {
					x:0, 
					y:0,
					clicked:false,
					beforeX:0,
					beforeY:0,
					ws:ws
				}
			},
			created(){
				interact(".draggable")
				.draggable({
					inertia: true,
					restrict: {
						restriction: "parent",
						endOnly: true
					},
					autoScroll: true,
					onstart: this.dragStart,
					onmove: this.dragMove,
					onend: this.dragEnd
				})
			},
			methods:{
				getTextWidth: function(text, font) {
					console.log(text);
					var canvas = this.getTextWidth.canvas || (this.getTextWidth.canvas = document.createElement("canvas"));
					var context = canvas.getContext("2d");
					context.font = font;
					var metrics = context.measureText(text);
					return metrics.width*0.6;
				},
				getPath: function(text){
					return `M0 0 L 5 5 V 1 
					A 1 1 90 0 1 6 0  
					h ${this.getTextWidth(text,"6px 'Lato', 'Noto Sans KR', sans-serif")}
					a 5 5 180 0 1 0 10 
					H 6 
					A 1 1 90 0 0 5 11 
					V 15 L 0 10 L 0 0 Z`;
				},
				log: console.log,
				dragStart: function(e){
					this.clicked = true;
					this.beforeX = e.clientX;
					this.beforeY = e.clientY;
					console.log("drag srart!",e.clientX,e.clientY);
				},
				dragMove: function(e){
					if(this.clicked){
						this.x += e.clientX - this.beforeX;
						this.y += e.clientY - this.beforeY;
						this.beforeX = e.clientX;
						this.beforeY = e.clientY;
						console.log("moving",e.clientX,e.clientY);
					}
				},
				dragEnd: function(e){
					this.clicked = false;
					this.x += e.clientX - this.beforeX;
					this.y += e.clientY - this.beforeY;
					console.log("drag end!",e.clientX,e.clientY);
				}
			}
		});
		var app = new Vue({
			el: "#app",
			data: {
				scenes: [
				{name: "장면 1", active: true}
				],
				ws: {
					scale: 10
				}
			},
			methods: {
				sceneChange: function(selectScene){
					for(var i=0;i<this.scenes.length;i++){
						this.scenes[i].active = false;
					}
					this.scenes[selectScene].active = true;
				}
			}
		});
		window.addEventListener("resize", canvasResize);
		$(canvasResize);
		
	</script>
	<script src="canvasDraw.js"></script>
</body>
</html>